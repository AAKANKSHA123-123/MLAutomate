name: CI/CD Pipeline

on:
  push:
    branches:
      - main   # Trigger workflow on push to main branch

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Windows self-hosted runner
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 3: Build and push Docker image (PowerShell syntax)
      - name: Build and push Docker image
        shell: pwsh
        run: |
          $IMAGE = "${{ secrets.DOCKER_USERNAME }}/linear-regression-app:latest"
          docker build -t $IMAGE .
          docker push $IMAGE

      # Step 4: Configure kubeconfig
      - name: Configure kubeconfig
        shell: pwsh
        run: |
          $env:KUBECONFIG="$HOME\.kube\config"
          if (-not (Test-Path $HOME\.kube)) {
              New-Item -ItemType Directory -Path $HOME\.kube
          }
          [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.KUBE_CONFIG_DATA }}")) | Out-File -Encoding utf8 $env:KUBECONFIG

      # Step 5: Deploy to Kubernetes
      - name: Deploy to Kubernetes
        shell: pwsh
        run: |
          kubectl apply -f deployment.yaml --validate=false
          kubectl apply -f service.yaml --validate=false


      # Step 6: Verify Deployment
      - name: Verify Deployment
        shell: pwsh
        run: |
          kubectl rollout status deployment/linear-regression-app
          kubectl get pods -o wide




  

# name: CI/CD Pipeline (KIND)

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: self-hosted   # Windows self-hosted runner

#     steps:
#       # 1️⃣ Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       # 2️⃣ Create KIND cluster
#       - name: Create KIND cluster
#         shell: pwsh
#         run: |
#           & "C:\Users\Aakanksha\tools\kind.exe" delete cluster --name ci-cluster || echo "No existing cluster"
#           & "C:\Users\Aakanksha\tools\kind.exe" create cluster --name ci-cluster

#       # 3️⃣ Build Docker image locally
#       - name: Build Docker image
#         shell: pwsh
#         run: |
#           docker build -t linear-regression-app:latest .

#       # 4️⃣ Load image into KIND cluster
#       - name: Load image into KIND
#         shell: pwsh
#         run: |
#           & "C:\Users\Aakanksha\tools\kind.exe" load docker-image linear-regression-app:latest --name ci-cluster

#       # 5️⃣ Deploy to Kubernetes
#       - name: Deploy to Kubernetes
#         shell: pwsh
#         run: |
#           kubectl apply -f deployment.yaml
#           kubectl apply -f service.yaml

#       # 6️⃣ Verify Deployment
#       - name: Verify Deployment
#         shell: pwsh
#         run: |
#           kubectl get nodes
#           kubectl get pods
#           kubectl rollout status deployment/linear-regression-deployment

